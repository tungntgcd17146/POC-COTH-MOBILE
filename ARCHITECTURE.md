# COTH Mobile - Architecture Documentation

## ğŸ›ï¸ System Architecture

### High-Level Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚                  COTH Mobile Ecosystem                          â”‚
â”‚              (Separate Monorepo from EasyMate)                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   React Native  â”‚              â”‚   NestJS API    â”‚
         â”‚   Mobile App    â”‚â—„â”€â”€â”€â”€RESTâ”€â”€â”€â”€â–ºâ”‚   (Port 3006)   â”‚
         â”‚                 â”‚              â”‚                 â”‚
         â”‚  - iOS App      â”‚              â”‚  - Auth Module  â”‚
         â”‚  - Android App  â”‚              â”‚  - User Module  â”‚
         â”‚  - Expo         â”‚              â”‚  - Profile      â”‚
         â”‚                 â”‚              â”‚  - Quota        â”‚
         â”‚  (TBD by FE)    â”‚              â”‚  - Activity     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  - Health       â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ Prisma ORM
                                                   â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   PostgreSQL    â”‚
                                          â”‚   Database      â”‚
                                          â”‚ (composer_db)   â”‚
                                          â”‚  Port: 5432     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ Shared DB
                                                   â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   EasyMate/     â”‚
                                          â”‚   Buela API     â”‚
                                          â”‚  (buela-all)    â”‚
                                          â”‚  Port: 3002     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      Same Database - Different Applications - No Data Duplication
```

---

## ğŸ“‚ Monorepo Structure

### Directory Layout

```
coth-mobile/                         # Root directory (separate from buela-all)
â”‚
â”œâ”€â”€ apps/                            # Applications
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                         # Backend API (Port: 3006)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ modules/             # Domain modules
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/           # Authentication
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user/           # User management
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ profile/        # Profile management
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ quota/          # Quota tracking
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ activity/       # Activity feed
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ health/         # Health monitoring
â”‚   â”‚   â”‚   â”œâ”€â”€ common/             # Shared code
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ prisma/         # Database service
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ filters/        # Exception filters
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ guards/         # Auth guards
â”‚   â”‚   â”‚   â”œâ”€â”€ app.module.ts       # Root module
â”‚   â”‚   â”‚   â””â”€â”€ main.ts             # Entry point
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â””â”€â”€ schema.prisma       # DB schema (subset)
â”‚   â”‚   â”œâ”€â”€ test/                   # Tests
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ mobile/                      # Mobile App (React Native)
â”‚       â”œâ”€â”€ src/                     # Frontend code (TBD)
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/                        # Shared packages
â”‚   â””â”€â”€ (future shared code)
â”‚
â”œâ”€â”€ tooling/                         # Build tools
â”‚   â””â”€â”€ (configs, scripts)
â”‚
â”œâ”€â”€ package.json                     # Root package.json
â”œâ”€â”€ turbo.json                       # Turborepo config
â””â”€â”€ .env.example                     # Environment template
```

---

## ğŸ—„ï¸ Database Architecture

### Shared Database Strategy

#### Why Shared Database?

**Decision**: Use the **same PostgreSQL database** as EasyMate/Buela

**Rationale**:
1. âœ… **No Data Migration**: Instant access to all user data
2. âœ… **Single Source of Truth**: No sync issues
3. âœ… **Zero Duplication**: Same users, same data
4. âœ… **Simpler Development**: No data sync logic
5. âœ… **Cost Effective**: One database to maintain
6. âœ… **Real-time Consistency**: Changes reflect immediately

### Database Connection

```typescript
// Both projects connect to the same database
// Location: localhost:5432/composer_db

// EasyMate/Buela (buela-all)
DATABASE_URL="postgresql://admin:admin@localhost:5432/composer_db"

// COTH Mobile (coth-mobile)
DATABASE_URL="postgresql://admin:admin@localhost:5432/composer_db"  // Same!
```

### Schema Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL Database                     â”‚
â”‚                     (composer_db)                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tables (97+ models)                               â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Core Tables:                                      â”‚ â”‚
â”‚  â”‚    - User                                          â”‚ â”‚
â”‚  â”‚    - Company                                       â”‚ â”‚
â”‚  â”‚    - Address                                       â”‚ â”‚
â”‚  â”‚    - AuthProvider                                  â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Agent Tables:                                     â”‚ â”‚
â”‚  â”‚    - Agent                                         â”‚ â”‚
â”‚  â”‚    - AgentUserConversation                        â”‚ â”‚
â”‚  â”‚    - AgentUserMessage                             â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Collection Tables:                                â”‚ â”‚
â”‚  â”‚    - CollectionDefinition                         â”‚ â”‚
â”‚  â”‚    - CollectionEntry                              â”‚ â”‚
â”‚  â”‚    - CollectionEntryData                          â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Quota Tables:                                     â”‚ â”‚
â”‚  â”‚    - QuotaDefinition                              â”‚ â”‚
â”‚  â”‚    - UserAgentQuota                               â”‚ â”‚
â”‚  â”‚    - QuotaUsage                                    â”‚ â”‚
â”‚  â”‚    - QuotaEvent                                    â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Audit & Activity:                                 â”‚ â”‚
â”‚  â”‚    - AuditLog                                      â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  And 80+ more tables...                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  Schema is maintained in:                               â”‚
â”‚    buela-all/apps/builder/api/prisma/schema/            â”‚
â”‚                                                          â”‚
â”‚  COTH Mobile uses a subset:                             â”‚
â”‚    coth-mobile/apps/api/prisma/schema.prisma            â”‚
â”‚    (includes only models needed for mobile API)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ API Architecture

### Module-Based Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COTH Mobile API                        â”‚
â”‚                  (NestJS Framework)                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  HTTP Layer (Express)                              â”‚ â”‚
â”‚  â”‚  - CORS                                            â”‚ â”‚
â”‚  â”‚  - Body Parser (50MB limit)                       â”‚ â”‚
â”‚  â”‚  - Rate Limiting (100 req/min)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Global Middleware                                 â”‚ â”‚
â”‚  â”‚  - Exception Filter                                â”‚ â”‚
â”‚  â”‚  - Validation Pipe                                 â”‚ â”‚
â”‚  â”‚  - Transform Pipe                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Feature Modules                                   â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚   Auth   â”‚  â”‚   User   â”‚  â”‚ Profile  â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  Module  â”‚  â”‚  Module  â”‚  â”‚  Module  â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚  Quota   â”‚  â”‚ Activity â”‚  â”‚  Health  â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  Module  â”‚  â”‚  Module  â”‚  â”‚  Module  â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Common Services                                   â”‚ â”‚
â”‚  â”‚  - Prisma Service (Database)                      â”‚ â”‚
â”‚  â”‚  - Auth Guards (JWT, OAuth)                       â”‚ â”‚
â”‚  â”‚  - Exception Filters                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Prisma ORM                                        â”‚ â”‚
â”‚  â”‚  - Query Builder                                   â”‚ â”‚
â”‚  â”‚  - Type Safety                                     â”‚ â”‚
â”‚  â”‚  - Connection Pool                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  PostgreSQL Database   â”‚
              â”‚    (Shared with        â”‚
              â”‚     EasyMate)          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Module Details

#### 1. Authentication Module

**Responsibilities**:
- User registration
- Login/logout
- JWT token management (access + refresh)
- Google OAuth integration
- Password hashing

**Components**:
```
auth/
â”œâ”€â”€ dto/                    # Data transfer objects
â”‚   â”œâ”€â”€ login.dto.ts
â”‚   â”œâ”€â”€ register.dto.ts
â”‚   â””â”€â”€ refresh-token.dto.ts
â”œâ”€â”€ guards/                 # Route guards
â”‚   â”œâ”€â”€ jwt-auth.guard.ts
â”‚   â””â”€â”€ google-auth.guard.ts
â”œâ”€â”€ strategies/             # Passport strategies
â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”œâ”€â”€ jwt-refresh.strategy.ts
â”‚   â””â”€â”€ google.strategy.ts
â”œâ”€â”€ auth.controller.ts      # HTTP endpoints
â”œâ”€â”€ auth.service.ts         # Business logic
â””â”€â”€ auth.module.ts          # Module definition
```

#### 2. User Management Module

**Responsibilities**:
- User CRUD operations
- User lookup (by UUID, email)
- User deletion (soft delete)

#### 3. Profile Module

**Responsibilities**:
- Extended user profile
- Profile updates
- Welcome/onboarding flow
- Additional information tracking

#### 4. Quota Module

**Responsibilities**:
- Quota information retrieval
- Usage tracking
- Event history
- Quota availability checks

#### 5. Activity Module

**Responsibilities**:
- Aggregated activity feed
- Conversation history
- Collection activity
- Multi-source aggregation

#### 6. Health Module

**Responsibilities**:
- Database health
- Memory monitoring
- Disk monitoring
- Kubernetes probes

---

## ğŸ” Security Architecture

### Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile  â”‚                           â”‚   API    â”‚
â”‚   App    â”‚                           â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                      â”‚
     â”‚  1. POST /auth/register             â”‚
     â”‚     or /auth/login                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚                                      â”‚
     â”‚                                 2. Validate
     â”‚                                    credentials
     â”‚                                      â”‚
     â”‚  3. Access Token (24h)              â”‚
     â”‚     Refresh Token (30d)             â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
     â”‚  4. API Request                     â”‚
     â”‚     Authorization: Bearer {token}   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚                                      â”‚
     â”‚                                 5. Verify JWT
     â”‚                                      â”‚
     â”‚  6. Response                        â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
     â”‚  7. Token Expired (after 24h)       â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
     â”‚  8. POST /auth/refresh              â”‚
     â”‚     { refreshToken }                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚                                      â”‚
     â”‚  9. New Access Token                â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
```

### OAuth Flow (Google)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile  â”‚          â”‚   API    â”‚          â”‚  Google  â”‚
â”‚   App    â”‚          â”‚          â”‚          â”‚   OAuth  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚                     â”‚
     â”‚  1. Open OAuth URL  â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
     â”‚                     â”‚                     â”‚
     â”‚  2. Redirect to     â”‚                     â”‚
     â”‚     Google          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                     â”‚                     â”‚
     â”‚  3. User authenticates with Google        â”‚
     â”‚     â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                     â”‚                     â”‚
     â”‚                     â”‚  4. OAuth callback  â”‚
     â”‚                     â”‚     with code       â”‚
     â”‚                     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                     â”‚                     â”‚
     â”‚                     â”‚  5. Exchange code   â”‚
     â”‚                     â”‚     for token       â”‚
     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                     â”‚                     â”‚
     â”‚                     â”‚  6. User profile    â”‚
     â”‚                     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                     â”‚                     â”‚
     â”‚                  7. Create/login user     â”‚
     â”‚                     â”‚                     â”‚
     â”‚  8. Access Token    â”‚                     â”‚
     â”‚     Refresh Token   â”‚                     â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                     â”‚                     â”‚
```

### Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Request Flow                          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. Rate Limiting (100 req/min)                    â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  2. CORS Check                                      â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  3. Body Parser (50MB limit)                       â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  4. JWT Validation (if protected route)            â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  5. Input Validation (class-validator)             â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  6. Business Logic                                  â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  7. Database Query (Prisma)                        â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  8. Response Transform                             â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  9. Error Handling (if any)                        â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  10. Response                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Deployment Architecture

### Development Environment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Developer Machine                      â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  COTH Mobile â”‚      â”‚  EasyMate/   â”‚             â”‚
â”‚  â”‚   (Port      â”‚      â”‚   Buela      â”‚             â”‚
â”‚  â”‚    3006)     â”‚      â”‚  (Port 3002) â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                     â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                    â”‚                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚            â”‚   PostgreSQL   â”‚                         â”‚
â”‚            â”‚  (Port 5432)   â”‚                         â”‚
â”‚            â”‚                â”‚                         â”‚
â”‚            â”‚  Docker        â”‚                         â”‚
â”‚            â”‚  Container     â”‚                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                        â”‚
â”‚  docker-compose-infrastructure.yml                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Production Environment (Proposed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Cloud Provider                       â”‚
â”‚                   (GCP / AWS / Azure)                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Load Balancer                                      â”‚ â”‚
â”‚  â”‚  (HTTPS/TLS)                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚      â”‚                   â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  COTH API â”‚    â”‚  EasyMate  â”‚                       â”‚
â”‚  â”‚  Cluster  â”‚    â”‚  Cluster   â”‚                       â”‚
â”‚  â”‚  (K8s/CR) â”‚    â”‚  (K8s/CR)  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚      â”‚                  â”‚                               â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚               â”‚                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚        â”‚  Cloud SQL  â”‚                                  â”‚
â”‚        â”‚ PostgreSQL  â”‚                                  â”‚
â”‚        â”‚  (Managed)  â”‚                                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Additional Services                                â”‚ â”‚
â”‚  â”‚  - Cloud Storage (files)                           â”‚ â”‚
â”‚  â”‚  - Redis (caching)                                  â”‚ â”‚
â”‚  â”‚  - Monitoring (Sentry, CloudWatch)                â”‚ â”‚
â”‚  â”‚  - CDN                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow

### User Activity Feed Example

```
Mobile App Request
       â”‚
       â”‚  GET /api/v1/activity/feed
       â”‚  Authorization: Bearer {token}
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway â”‚  1. Validate JWT
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  2. Extract user info
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  3. Call service method
â”‚  Controller  â”‚     getActivityFeed()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  4. Query multiple sources
â”‚  Service     â”‚     - Audit logs
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     - Conversations
       â”‚             - Collections
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prisma      â”‚  5. Execute queries
â”‚  Service     â”‚     - auditLog.findMany()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     - conversation.findMany()
       â”‚             - collectionEntry.findMany()
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL  â”‚  6. Fetch data
â”‚  Database    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  7. Aggregate results
â”‚  Service     â”‚  8. Sort by timestamp
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  9. Paginate
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  10. Transform to DTO
â”‚  Controller  â”‚  11. Return response
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    Mobile App
  (Activity Feed)
```

---

## ğŸ¯ Scalability Considerations

### Horizontal Scaling

- **API Servers**: Stateless, can scale horizontally
- **Database**: Shared, can use read replicas
- **Caching**: Redis cluster for distributed caching

### Performance Optimization

- Connection pooling (10-50 connections)
- Query optimization with Prisma
- Response caching where appropriate
- Rate limiting to prevent abuse

---

**Version**: 1.0.0
**Last Updated**: 2025-10-17
**Status**: POC Complete
