# COTH Mobile - Architecture Documentation

## ğŸ›ï¸ System Architecture

### High-Level Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚                  COTH Mobile Ecosystem                          â”‚
â”‚              (Separate Monorepo from EasyMate)                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   React Native  â”‚              â”‚   NestJS API    â”‚
         â”‚   Mobile App    â”‚â—„â”€â”€â”€â”€RESTâ”€â”€â”€â”€â–ºâ”‚   (Port 3006)   â”‚
         â”‚                 â”‚              â”‚                 â”‚
         â”‚  - iOS App      â”‚              â”‚  - Auth Module  â”‚
         â”‚  - Android App  â”‚              â”‚  - User Module  â”‚
         â”‚  - Expo         â”‚              â”‚  - Health       â”‚
         â”‚                 â”‚              â”‚                 â”‚
         â”‚  (TBD by FE)    â”‚              â”‚  (Other modules â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   TBD later)    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ Prisma ORM
                                                   â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   PostgreSQL    â”‚
                                          â”‚   Database      â”‚
                                          â”‚  (coth_mobile)  â”‚
                                          â”‚  Port: 5432     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ Data Migration
                                                   â”‚ (planned later)
                                                   â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   EasyMate/     â”‚
                                          â”‚   Buela API     â”‚
                                          â”‚  (buela-all)    â”‚
                                          â”‚  Port: 3002     â”‚
                                          â”‚  (composer_db)  â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      Separate Databases - Will migrate/link data later
```

---

## ğŸ“‚ Monorepo Structure

### Directory Layout

```
coth-mobile/                         # Root directory (separate from buela-all)
â”‚
â”œâ”€â”€ apps/                            # Applications
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                         # Backend API (Port: 3006)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ modules/             # Domain modules
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/           # Authentication
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user/           # User management
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ health/         # Health monitoring
â”‚   â”‚   â”‚   â”‚   # (Other modules TBD later)
â”‚   â”‚   â”‚   â”œâ”€â”€ common/             # Shared code
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ prisma/         # Database service
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ filters/        # Exception filters
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ guards/         # Auth guards
â”‚   â”‚   â”‚   â”œâ”€â”€ app.module.ts       # Root module
â”‚   â”‚   â”‚   â””â”€â”€ main.ts             # Entry point
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â””â”€â”€ schema.prisma       # DB schema (separate DB)
â”‚   â”‚   â”œâ”€â”€ test/                   # Tests
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ mobile/                      # Mobile App (React Native)
â”‚       â”œâ”€â”€ src/                     # Frontend code (TBD)
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/                        # Shared packages
â”‚   â””â”€â”€ (future shared code)
â”‚
â”œâ”€â”€ tooling/                         # Build tools
â”‚   â””â”€â”€ (configs, scripts)
â”‚
â”œâ”€â”€ package.json                     # Root package.json
â”œâ”€â”€ turbo.json                       # Turborepo config
â””â”€â”€ .env.example                     # Environment template
```

---

## ğŸ—„ï¸ Database Architecture

### Separate Database Strategy

#### Why Separate Database?

**Decision**: Use a **separate PostgreSQL database** for COTH Mobile

**Rationale**:
1. âœ… **Independent Evolution**: COTH can evolve without affecting EasyMate
2. âœ… **Clear Boundaries**: Better separation of concerns
3. âœ… **Simpler Schema**: Only models needed for mobile features
4. âœ… **Easier Testing**: Can reset/test without affecting EasyMate
5. âœ… **Migration Flexibility**: Can migrate/link data when ready
6. âœ… **Performance Isolation**: COTH load won't impact EasyMate

### Database Connection

```typescript
// Separate databases for each project

// EasyMate/Buela (buela-all)
DATABASE_URL="postgresql://admin:admin@localhost:5432/composer_db"

// COTH Mobile (coth-mobile) - Different database
DATABASE_URL="postgresql://admin:admin@localhost:5432/coth_mobile"
```

### Schema Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              COTH Mobile PostgreSQL Database              â”‚
â”‚                     (coth_mobile)                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Core Tables (MVP - User & Auth Only)              â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  User Management:                                  â”‚ â”‚
â”‚  â”‚    - User         (core user model)                â”‚ â”‚
â”‚  â”‚    - AuthProvider (OAuth providers)                â”‚ â”‚
â”‚  â”‚    - Role         (user roles/permissions)         â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Enums:                                            â”‚ â”‚
â”‚  â”‚    - EnumUserRole                                  â”‚ â”‚
â”‚  â”‚    - EnumUserStatus                                â”‚ â”‚
â”‚  â”‚    - EnumRegistrationReferralChannel               â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  Other models will be added later as needed       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  Schema is maintained in:                               â”‚
â”‚    coth-mobile/apps/api/prisma/schema.prisma            â”‚
â”‚                                                          â”‚
â”‚  Data Migration Strategy (Future):                      â”‚
â”‚    - Option 1: Periodic sync from EasyMate             â”‚
â”‚    - Option 2: API-based data access                   â”‚
â”‚    - Option 3: ETL pipeline                            â”‚
â”‚    - Decision: TBD based on requirements               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            EasyMate PostgreSQL Database                   â”‚
â”‚                     (composer_db)                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Full Schema (97+ models)                          â”‚ â”‚
â”‚  â”‚    - All EasyMate/Buela features                   â”‚ â”‚
â”‚  â”‚    - Agent, Collections, Workflows, etc.           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ API Architecture

### Module-Based Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COTH Mobile API                        â”‚
â”‚                  (NestJS Framework)                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  HTTP Layer (Express)                              â”‚ â”‚
â”‚  â”‚  - CORS                                            â”‚ â”‚
â”‚  â”‚  - Body Parser (50MB limit)                       â”‚ â”‚
â”‚  â”‚  - Rate Limiting (100 req/min)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Global Middleware                                 â”‚ â”‚
â”‚  â”‚  - Exception Filter                                â”‚ â”‚
â”‚  â”‚  - Validation Pipe                                 â”‚ â”‚
â”‚  â”‚  - Transform Pipe                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Feature Modules                                   â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚   Auth   â”‚  â”‚   User   â”‚  â”‚  Health  â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  Module  â”‚  â”‚  Module  â”‚  â”‚  Module  â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  (Other modules will be added later as needed)    â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Common Services                                   â”‚ â”‚
â”‚  â”‚  - Prisma Service (Database)                      â”‚ â”‚
â”‚  â”‚  - Auth Guards (JWT, OAuth)                       â”‚ â”‚
â”‚  â”‚  - Exception Filters                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Prisma ORM                                        â”‚ â”‚
â”‚  â”‚  - Query Builder                                   â”‚ â”‚
â”‚  â”‚  - Type Safety                                     â”‚ â”‚
â”‚  â”‚  - Connection Pool                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  PostgreSQL Database   â”‚
              â”‚    (Shared with        â”‚
              â”‚     EasyMate)          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Module Details

#### 1. Authentication Module

**Responsibilities**:
- User registration
- Login/logout
- JWT token management (access + refresh)
- Google OAuth integration
- Password hashing

**Components**:
```
auth/
â”œâ”€â”€ dto/                    # Data transfer objects
â”‚   â”œâ”€â”€ login.dto.ts
â”‚   â”œâ”€â”€ login.input.ts
â”‚   â”œâ”€â”€ register.dto.ts
â”‚   â”œâ”€â”€ register.input.ts
â”‚   â””â”€â”€ refresh-token.dto.ts
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ auth-response.entity.ts
â”œâ”€â”€ guards/                 # Route guards
â”‚   â”œâ”€â”€ jwt-auth.guard.ts
â”‚   â”œâ”€â”€ gql-auth.guard.ts
â”‚   â””â”€â”€ google-auth.guard.ts
â”œâ”€â”€ strategies/             # Passport strategies
â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”œâ”€â”€ jwt-refresh.strategy.ts
â”‚   â””â”€â”€ google.strategy.ts
â”œâ”€â”€ decorators/
â”‚   â””â”€â”€ current-user.decorator.ts
â”œâ”€â”€ auth.controller.ts      # REST endpoints
â”œâ”€â”€ auth.resolver.ts        # GraphQL resolvers
â”œâ”€â”€ auth.service.ts         # Business logic
â””â”€â”€ auth.module.ts          # Module definition
```

#### 2. User Management Module

**Responsibilities**:
- User CRUD operations
- User lookup (by UUID, email)
- User deletion (soft delete)
- User profile management

**Components**:
```
user/
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ user.entity.ts
â”œâ”€â”€ user.controller.ts      # REST endpoints
â”œâ”€â”€ user.resolver.ts        # GraphQL resolvers
â”œâ”€â”€ user.service.ts         # Business logic
â””â”€â”€ user.module.ts          # Module definition
```

#### 3. Health Module

**Responsibilities**:
- Database health checks
- Memory monitoring
- Disk monitoring
- Kubernetes probes (liveness/readiness)

**Components**:
```
health/
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ health-status.entity.ts
â”œâ”€â”€ health.controller.ts    # REST endpoints
â”œâ”€â”€ health.resolver.ts      # GraphQL resolvers
â”œâ”€â”€ health.service.ts       # Health check logic
â””â”€â”€ health.module.ts        # Module definition
```

#### Future Modules (TBD)

These modules will be implemented later based on requirements:
- Profile Module (extended user information)
- Quota Module (usage tracking)
- Activity Module (activity feed)
- Other domain-specific modules

---

## ğŸ” Security Architecture

### Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile  â”‚                           â”‚   API    â”‚
â”‚   App    â”‚                           â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                      â”‚
     â”‚  1. POST /auth/register             â”‚
     â”‚     or /auth/login                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚                                      â”‚
     â”‚                                 2. Validate
     â”‚                                    credentials
     â”‚                                      â”‚
     â”‚  3. Access Token (24h)              â”‚
     â”‚     Refresh Token (30d)             â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
     â”‚  4. API Request                     â”‚
     â”‚     Authorization: Bearer {token}   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚                                      â”‚
     â”‚                                 5. Verify JWT
     â”‚                                      â”‚
     â”‚  6. Response                        â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
     â”‚  7. Token Expired (after 24h)       â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
     â”‚  8. POST /auth/refresh              â”‚
     â”‚     { refreshToken }                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
     â”‚                                      â”‚
     â”‚  9. New Access Token                â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                      â”‚
```

### OAuth Flow (Google)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile  â”‚          â”‚   API    â”‚          â”‚  Google  â”‚
â”‚   App    â”‚          â”‚          â”‚          â”‚   OAuth  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚                     â”‚
     â”‚  1. Open OAuth URL  â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
     â”‚                     â”‚                     â”‚
     â”‚  2. Redirect to     â”‚                     â”‚
     â”‚     Google          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                     â”‚                     â”‚
     â”‚  3. User authenticates with Google        â”‚
     â”‚     â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                     â”‚                     â”‚
     â”‚                     â”‚  4. OAuth callback  â”‚
     â”‚                     â”‚     with code       â”‚
     â”‚                     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                     â”‚                     â”‚
     â”‚                     â”‚  5. Exchange code   â”‚
     â”‚                     â”‚     for token       â”‚
     â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                     â”‚                     â”‚
     â”‚                     â”‚  6. User profile    â”‚
     â”‚                     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                     â”‚                     â”‚
     â”‚                  7. Create/login user     â”‚
     â”‚                     â”‚                     â”‚
     â”‚  8. Access Token    â”‚                     â”‚
     â”‚     Refresh Token   â”‚                     â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
     â”‚                     â”‚                     â”‚
```

### Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Request Flow                          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. Rate Limiting (100 req/min)                    â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  2. CORS Check                                      â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  3. Body Parser (50MB limit)                       â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  4. JWT Validation (if protected route)            â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  5. Input Validation (class-validator)             â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  6. Business Logic                                  â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  7. Database Query (Prisma)                        â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  8. Response Transform                             â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  9. Error Handling (if any)                        â”‚ â”‚
â”‚  â”‚     â†“                                               â”‚ â”‚
â”‚  â”‚  10. Response                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Deployment Architecture

### Development Environment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Developer Machine                      â”‚
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  COTH Mobile â”‚      â”‚  EasyMate/   â”‚             â”‚
â”‚  â”‚   (Port      â”‚      â”‚   Buela      â”‚             â”‚
â”‚  â”‚    3006)     â”‚      â”‚  (Port 3002) â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                     â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                    â”‚                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚            â”‚   PostgreSQL   â”‚                         â”‚
â”‚            â”‚  (Port 5432)   â”‚                         â”‚
â”‚            â”‚                â”‚                         â”‚
â”‚            â”‚  Docker        â”‚                         â”‚
â”‚            â”‚  Container     â”‚                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                        â”‚
â”‚  docker-compose-infrastructure.yml                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Production Environment (Proposed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Cloud Provider                       â”‚
â”‚                   (GCP / AWS / Azure)                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Load Balancer                                      â”‚ â”‚
â”‚  â”‚  (HTTPS/TLS)                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚      â”‚                   â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  COTH API â”‚    â”‚  EasyMate  â”‚                       â”‚
â”‚  â”‚  Cluster  â”‚    â”‚  Cluster   â”‚                       â”‚
â”‚  â”‚  (K8s/CR) â”‚    â”‚  (K8s/CR)  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚      â”‚                  â”‚                               â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚               â”‚                                         â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚        â”‚  Cloud SQL  â”‚                                  â”‚
â”‚        â”‚ PostgreSQL  â”‚                                  â”‚
â”‚        â”‚  (Managed)  â”‚                                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Additional Services                                â”‚ â”‚
â”‚  â”‚  - Cloud Storage (files)                           â”‚ â”‚
â”‚  â”‚  - Redis (caching)                                  â”‚ â”‚
â”‚  â”‚  - Monitoring (Sentry, CloudWatch)                â”‚ â”‚
â”‚  â”‚  - CDN                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow

### User Activity Feed Example

```
Mobile App Request
       â”‚
       â”‚  GET /api/v1/activity/feed
       â”‚  Authorization: Bearer {token}
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway â”‚  1. Validate JWT
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  2. Extract user info
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  3. Call service method
â”‚  Controller  â”‚     getActivityFeed()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  4. Query multiple sources
â”‚  Service     â”‚     - Audit logs
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     - Conversations
       â”‚             - Collections
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prisma      â”‚  5. Execute queries
â”‚  Service     â”‚     - auditLog.findMany()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     - conversation.findMany()
       â”‚             - collectionEntry.findMany()
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL  â”‚  6. Fetch data
â”‚  Database    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  7. Aggregate results
â”‚  Service     â”‚  8. Sort by timestamp
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  9. Paginate
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity    â”‚  10. Transform to DTO
â”‚  Controller  â”‚  11. Return response
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    Mobile App
  (Activity Feed)
```

---

## ğŸ¯ Scalability Considerations

### Horizontal Scaling

- **API Servers**: Stateless, can scale horizontally
- **Database**: Shared, can use read replicas
- **Caching**: Redis cluster for distributed caching

### Performance Optimization

- Connection pooling (10-50 connections)
- Query optimization with Prisma
- Response caching where appropriate
- Rate limiting to prevent abuse

---

**Version**: 1.0.0
**Last Updated**: 2025-10-17
**Status**: POC Complete
